{% extends "base.html" %}
{% block title %} Crea un nuovo corso {% endblock %}

{% block extra_head %}
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
{% endblock %}

{% block content %}
    <center>
        <form class="register-form" method="POST">
            <h1> <strong>CREA UN NUOVO CORSO</strong> </h1>
            <div class="input_fields">

                <label for="titolo"><b>Titolo</b></label>
                <input type="text" id="titolo" name="titolo" class="inputform" required>

                <br>

                <label for="descrizione"><b>Descrizione</b></label>
                <input type="text" id="descrizione" name="descrizione" class="inputform" required>

                <br>


                <div id="search-bar">
                    <label for="organizzatori"><b>Organizzatori</b></label>
                    <input v-model="selection_str" type="text" id="organizzatori" name="organizzatori" class="inputform" required style="visibility:hidden">

                    <input v-model="query" @input="search" placeholder="Cerca studenti..." />

                    <ul v-if="results.length">
                        <li v-for="user in results" :key="user.id">
                            <p @click="select([[ user.email ]])"> [[ user.full_name ]] </p>
                        </li>
                    </ul>

                    <p v-if="loading">Searching... [[ query ]] </p>
                <br>

                <label for="fascia"><b>Fasce</b></label>
                <br>

                <input type="checkbox" id="fascia1" name="fascia1" class="inputform">
                <label for="fascia1">Fascia 1</label>
                <br>
                <input type="checkbox" id="fascia2" name="fascia2" class="inputform">
                <label for="fascia2">Fascia 2</label>
                <br>
                <input type="checkbox" id="fascia3" name="fascia3" class="inputform">
                <label for="fascia3">Fascia 3</label>
                <br>
                <input type="checkbox" id="fascia4" name="fascia4" class="inputform">
                <label for="fascia4">Fascia 4</label>
                <br>
                <input type="checkbox" id="fascia5" name="fascia5" class="inputform">
                <label for="fascia5">Fascia 5</label>
                <br>

                <br>

                <label for="note"><b>Note</b></label>
                <input type="text" id="note" name="note" class="inputform">

            </div>
            <button type="submit" class="outline_md_btn">
                Crea
            </button>
        </form>
    </center>

    <script>
        const { createApp } = Vue;

        createApp({
            delimiters: ['[[', ']]'],
            data() {
                return {
                    query: "",
                    results: [],
                    selected: [],
                    loading: false,
                    timeout: null,
                    selection_str: "";
                };
            },
            methods: {
                search() {
                    clearTimeout(this.timeout);

                    console.log("search");

                    this.timeout = setTimeout(async () => {
                        if (this.query.length < 2) {
                            this.results = [];
                            return;
                        }

                        this.loading = true;
                        const res = await fetch(`/get_students/${this.query}`, {
                            method:"GET",
                        });
                        console.log(res);

                        this.results = await res.json();
                        console.log(this.results)
                        console.log(this.results["name"])
                        this.loading = false;
                    }, 300);
                },

                clear() {
                    this.results = [];
                    this.query = "";
                    this.loading = false;
                    this.timeout = null;
                    this.selection_str = "";
                },

                select(email) {

                    this.clear()
                    console.log(`added ${email}`)

                    this.selection_str += ";" + email
                },

                deselect(email) {

                    console.log(`removed ${email}`)
                    this.selection_str = this.selection_str.replace(email, "")
                }
            }
        }).mount("#search-bar");
        console.log("prova");
    </script>
{% endblock %}
